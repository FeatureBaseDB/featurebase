version: '2'
services: 
  pilosa1:
    build:
      context: ../..
      dockerfile: Dockerfile-clustertests
    image: ptest
    ports:
      - "33455:10101"
    environment:
      - PILOSA_NAME=pilosa1
      - PILOSA_ETCD_LISTEN_CLIENT_ADDRESS=http://0.0.0.0:10201
      - PILOSA_ETCD_ADVERTISE_CLIENT_ADDRESS=http://pilosa1:10201
      - PILOSA_ETCD_LISTEN_PEER_ADDRESS=http://0.0.0.0:10301
      - PILOSA_ETCD_ADVERTISE_PEER_ADDRESS=http://pilosa1:10301
      - PILOSA_ETCD_INITIAL_CLUSTER=pilosa1=http://pilosa1:10301,pilosa2=http://pilosa2:10301,pilosa3=http://pilosa3:10301
    networks:
      - pilosanet
    command:
      - "/featurebase server --bind pilosa1:10101"
  pilosa2:
    build:
      context: ../..
      dockerfile: Dockerfile-clustertests
    image: ptest
    ports:
      - "33456:10101"
    environment:
      - PILOSA_NAME=pilosa2
      - PILOSA_ETCD_LISTEN_CLIENT_ADDRESS=http://0.0.0.0:10201
      - PILOSA_ETCD_ADVERTISE_CLIENT_ADDRESS=http://pilosa2:10201
      - PILOSA_ETCD_LISTEN_PEER_ADDRESS=http://0.0.0.0:10301
      - PILOSA_ETCD_ADVERTISE_PEER_ADDRESS=http://pilosa2:10301
      - PILOSA_ETCD_INITIAL_CLUSTER=pilosa1=http://pilosa1:10301,pilosa2=http://pilosa2:10301,pilosa3=http://pilosa3:10301
    networks:
      - pilosanet
    command:
      - "/featurebase server --bind pilosa2:10101"
  pilosa3:
    build:
      context: ../..
      dockerfile: Dockerfile-clustertests
    image: ptest
    ports:
      - "33457:10101"
    environment:
      - PILOSA_NAME=pilosa3
      - PILOSA_ETCD_LISTEN_CLIENT_ADDRESS=http://0.0.0.0:10201
      - PILOSA_ETCD_ADVERTISE_CLIENT_ADDRESS=http://pilosa3:10201
      - PILOSA_ETCD_LISTEN_PEER_ADDRESS=http://0.0.0.0:10301
      - PILOSA_ETCD_ADVERTISE_PEER_ADDRESS=http://pilosa3:10301
      - PILOSA_ETCD_INITIAL_CLUSTER=pilosa1=http://pilosa1:10301,pilosa2=http://pilosa2:10301,pilosa3=http://pilosa3:10301
    networks:
      - pilosanet
    command:
      - "/featurebase server --bind pilosa3:10101"
  client1:
    build:
      context: .
    environment:
      - ENABLE_PILOSA_CLUSTER_TESTS=1
      - GO111MODULE=on
    networks:
      - pilosanet
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - "cd /go/src/github.com/pilosa/pilosa/ && go test -mod=vendor -v -count=1 github.com/pilosa/pilosa/v2/internal/clustertests"
networks: 
  pilosanet:
